{% extends 'SkreenHouseFactoryV3Bundle::layout.html.twig' %}
{% block meta %}
<meta property="og:title" content="{{ program.title }}" />
<meta property="og:description" content="{{ program.description_seo }}" />
<meta property="og:image" content="{{ program.picture }}" />
<meta property="og:type" content="{% if program.format %}{% if program.format.name == 'Série' %}video.episode{% elseif program.format.name in ['Emission','Journal'] %}video.tv_show{% else %}video.movie{% endif %}{% else %}video.movie{% endif %}" />
<meta property="og:url" content="http://www.myskreen.com{{ program.seo_url }}" />
<meta property="og:video" content="{{ program.player_fb }}" />
<meta name="medium" content="mult" />
<meta property="og:video:height" content="358" />
<meta property="og:video:width" content="576" />
<meta property="og:video:type" content="application/x-shockwave-flash" />
<meta property="og:video:duration" content="{{ program.duration * 60 }}" />
<meta name="video_height" content="470" />
<meta name="video_width" content="940" />
<link rel="video_src" href="{{ program.player_fb }}" />
<meta name="video_type" content="application/x-shockwave-flash" />
<meta name="video_duration" content="{{ program.duration * 60 }}" />
<link rel="image_src" href="{{ program.picture }}" />
<meta name="object_type" content="episode" />
{% endblock %}
{% block title %}{{ program.title }}{% endblock %}
{% block description %}{{ program.description_seo|replace({"\n": ''})|striptags|slice(0, 165) }}{% endblock %}

{% block content %}
<div id="view-program" data-id="{{ program.id }}" class="container">

  <div class="program-title">
    {% if program.episode_title is defined %}
    <h1>{{ program.episodeof.title }} ~ <span>{{ program.episode_title }}</span></h1>
    {% else %}
    <h1>{{ program.title }}</h1>
    {% endif %}
  </div>
  <div id="program-description">
    <p id="synopsis" class="lead">
    {{ program.description_seo }}
    {#% if program.description_seo|length > 200 %}
      <a href="#" onClick="$('#synopsis').css('height', 'auto');$(this).addClass('hide');" class="bgbodyfade"> &raquo; {{ 'program.desc.read'|trans }}</a>
    {% endif %#}
    </p>
  </div>

  <div class="view-main view-program-main pull-right">

    <div id="program-follow" class="actions" data-id="{{ program.id }}">
      <a class="fav btn btn-large btn-primary" data-placement="left"><i class="icon-plus-sign icon-white"></i> {{ 'action.add.favorites'|trans }}</a>
    </div>

    <div id="program-main-block">
    {% if program.teaser %}
      <a name="teaser"></a>
      <div id="program-teaser">
      <a style="margin:10px" class="btn btn-large btn-inverse pull-right trigger-tv" href="#" data-couchmode="{{ {'type': 'program', 'id': program.id, 'hide_sliders': true}|json_encode }}"><i class="icon-off icon-white"></i> {{ 'program.tv.on'|trans }}</a>
      <div id="program-teaser-meta" class="player-meta"></div>
      <div id="program-teaser-player" data-play-autoload="{{ program.teaser.id }}" data-play-meta-elmt="#program-teaser-meta" data-play-muted="1" data-play-args="{{ {hide_sliders: 1}|json_encode }}"></div>
      </div>
    {% endif %}

    <a name="program-offers"></a>
    <div id="program-offers" class="view-program-block">
      {% if program.theater_release_date is defined %}
        <p class="alert alert-success">Sortie en salle le <strong>{{ program.theater_release_date }}</strong>{# <a href="#" data-ics-date="{{ program.theater_release_date }}"><i class="icon-agenda"></i> Ajouter à votre agenda</a>#}</p>
      {% elseif program.has_vod == 0 %}
        <p class="alert alert-success">Ce programme n'est pas diffusé pour le moment. Cliquez sur &laquo; Suivre &raquo; pour être averti dès qu'il sera disponible.</p>
      {% else %}
      <ul id="triggers" class="nav nav-pills" style="font-size: 1.2em;">
        {% for key in offers|keys if program.offers[key]|length or key == 'deportes' %}
        <li{% if loop.first %} class="active"{% endif %}><a href="#{{ key }}" id="trigger-{{ key }}" data-toggle="tab" data-nb="{{ program.offers[key]|length }}">{{ offers[key] }}{% if key == 'theaters' %}({% if program.datas_theaters.theaters_ids|length %}{{ program.datas_theaters.theaters_ids|length }}{% else %}1{% endif %}){% elseif program.offers[key]|length %} ({{ program.offers[key]|length }}){% endif %}</a></li>
        {% endfor %}
      </ul>
      <div class="tab-content">
        {% for key in offers|keys if program.offers[key]|length or key == 'deportes' %}
        <div id="{{ key }}" class="tab-pane{% if loop.first %} active{% endif %}">
        {%  if program.offers[key]|length %}
        <div class="table-container">
        <table class="table">
          <tbody>
          {%  if key != 'theaters' %}
            {% set other_episodes = '' %}
            {% for o in program.offers[key] %}
              {% set o_channel = attribute(program.datas_offers.channels, o.channel_id) %}
              {% set o_access = attribute(program.datas_offers.access, o.access_id) %}
              {% if o.episode_id is defined %}
              {% set o_episode = attribute(program.datas_offers.episodes,  o.episode_id) %}
              {% else %}
              {% set o_episode = '' %}
              {% endif %}
              {% if o.episode_id is defined and 
                    program.episodeof.id is defined and 
                    o.episode_id != program.id and
                    other_episodes != 'ok' %}
              <tr><td colspan="5"><h6>Autres épisodes</h6></td></tr>
              {% set other_episodes = 'ok' %}
              {% endif %}
              
              <tr data-id="{{ o.id }}"{% if o.url is defined and o.url %} data-redirect="{{ o.url }}"{% elseif key == 'deportes' %} data-play="{{ o.id }}" data-play-args="{{ {hide_sliders: 1}|json_encode }}"{% elseif key == 'broadcasts' %} data-ics-occurrence="{{ o.id }}"{% endif %}>
                <td width="20px"><span class="badge" style="opacity:0.1;">0</span></td>
                  {% if o_episode %}
                  <td class="episode" data-episode-id="{{ o_episode.id }}" data-content="{{ 'loading'|trans }}" data-original-title="{{ o_episode.title }}" data-toggle="hover" data-placement="left">
                  <img class="pull-left" src="{{ o_episode.picture }}" alt="{{ o_episode.title }}" />{{ o_episode.title }}
                  <br/><em>{% if o_episode.season_number is defined %}Saison {{ o_episode.season_number }}{% endif %} {% if o_episode.episode_number is defined %}Episode {{ o_episode.episode_number }}{% endif %}</em>
                {% else %}
                <td>
                {% endif %}
                  {% if o.replay_remaining is defined and o.replay_remaining %}
                    {% if o.replay_remaining < 0 %}
                    <span class="label label-info">Bientôt disponible en Replay</span>
                    {% else %}
                    <span class="label label-info">En Replay dans {{ (o.replay_remaining/60)|number_format }}h</span>
                    {% endif %}
                  {% elseif o.timeleft is defined and o.timeleft %}
                    {% if o.timeleft < 0 %}
                    <span class="label">timeleft ?</span>
                    {% elseif o_access.name == 'TV' %}
                    <span class="label label-warning">Dans {{ (o.timeleft/60)|number_format }}h</span>
                    {% else %}
                    <span class="label label-{% if o.timeleft > 24*60 %}warning{% else %}important{% endif %}">Plus que {{ (o.timeleft/60)|number_format }}h pour le voir</span>
                    {% endif %}
                  {% endif %}
                </td>
                <td class="access">
                  {% if o_access.name != 'Live' and o_access.name != 'TV' %}
                    {% if o.url is defined and o.url %}<i class="icon-share"></i>
                    {% elseif key == 'deportes' %}<i class="icon-play"></i>
                    {% endif %}
                    {{ o_access.name }}, 
                    {% if o.cost is defined %}
                      {% if o.cost > 0 %}{{ o.cost }}&euro;
                      {% elseif o_access.is_achat or o_access.is_location %}- &euro;
                      {% else %}{{ 'free'|trans }}
                      {% endif %}
                    {% else %}
                      {{ 'free'|trans }}
                    {% endif %}
                  {% endif %}
                  {% if o.broadcastdate is defined %}
                    {% if o_access.name == 'TV' %}<i class="icon-calendar"></i>
                    {% else %}<br/>
                    {% endif %}
                    <em>{{ o.broadcastdate }}{#{ o.broadcastdate|localizeddate('full', 'none') }#}</em>
                  {% endif %}
                </td>
                <td class="channel">
                  <img src="{{ o_channel.img }}" alt="{{ o_channel.name }}" />
                </td>
                <td class="tag">
                  {#% if o.tags is defined %}
                  {{ dump(o.tags) }}
                  {% endif %#}
                  {% if o.tags.version is defined %}
                    <span class="label label-inverse">{{ o.tags.version|replace({',': ', '}) }}</span><br/>
                  {% endif %}
                  {% if o.tags.hd is defined %}
                    <span class="label label-info">{{ o.tags.hd }}</span><br/>
                  {% endif %}
                  {% if o.tags.device is defined %}
                    <span class="label">{{ o.tags.device|replace({',': ', '}) }}</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" class="theaters">
                {% if program.datas_theaters.theaters_ids|length > 0 %}
                  <p class="alert alert-info">{{ program.format.name }} projeté {% if program.theater_release_date is defined %} en avant-première{% endif %} dans {{ program.datas_theaters.theaters_ids|length }} salles.</p>
                  <form id="theaters-search" class="form-search pull-left">
                    <div class="input-append">
                      <input type="text" class="span3 search-query" placeholder="{{ 'program.theaters.search.placeholder'|trans }}">
                      <button type="submit" class="btn"><i class="icon-search"></i> {{ 'program.theaters.search.submit'|trans }}</button>
                    </div>
                  </form>
                  <a class="btn" href="#" id="trigger-theaters-geoloc"><i class="icon-map-marker"></i> Séances près d'ici</a>
                  <div id="theaters-list" class="clear" data-api-url="{{ path('programtheater', {id: program.id}) }}" data-theaters-ids="{{ program.datas_theaters.theaters_ids|join(',')  }}"></div>
                {% endif %}
                {% if program.datas_theaters.theaters_on_demand|length %}
                  {% for o in program.datas_theaters.theaters_on_demand %}
                  <hr/>
                  <p align="center"><a target="_blank" href="{{ attribute(o, 'url') }}"><img class="img-polaroid" src="{{ asset('bundles/skreenhousefactoryv3/images/partenaires/ilikecinema.png') }}" alt="ilikecinema" /></a></p>
                  {% endfor %}
                {% endif %}
              </td>
            </tr>
          {% endif %}
          </tbody>
        </table>
        </div>
        {% endif %}
        {% if key == 'deportes' %}
          <div class="program-deportes" data-more-streaming="{{ program.id }}">
            <div id="ytCarousel" class="carousel slide hide">
              <div class="carousel-inner"></div>
              <a class="carousel-control left" href="#ytCarousel" data-slide="prev">&lsaquo;</a>
              <a class="carousel-control right" href="#ytCarousel" data-slide="next">&rsaquo;</a>
            </div>
          </div>
        {% endif %}
        </div>
        {% endfor %}
      </div>
    {% endif %}
    </div>
  </div>
  </div>

  {% if program.format %}
  <ul class="breadcrumb">
    <li itemscope itemtype="http://data-vocabulary.org/Breadcrumb"><a itemprop="url" href="{{ path('any_url', {url: program.format.seo_url|replace({'/': ''})}) }}/"><span itemprop="title">{{ program.format.name }}</span></a> <span class="divider">/</span></li>
    {% if program.categories|length %}
    <li itemscope itemtype="http://data-vocabulary.org/Breadcrumb">{% for c in program.categories|slice(0,1) %}{% if loop.first %}{% else %}, {% endif %}<a itemprop="url" href="{{ path('category', {format: program.format.seo_url|replace({'/': ''}), category_slug: c.seo_url|replace({'/': ''})}) }}"><span itemprop="title">{{ c.name }}</span></a>{% endfor %} <span class="divider">/</span></li>
    {% endif %}
    {% if program.subcategories|length %}
    <li{% if program.episode_title is not defined %} class="active"{% endif %} itemscope itemtype="http://data-vocabulary.org/Breadcrumb">{% for c in program.subcategories|slice(0,1) %}{% if loop.first %}{% else %}, {% endif %}<a itemprop="url" href="{{ path('any_url', {url: program.format.seo_url|replace({'/': ''}) ~ c.seo_url}) }}"><span itemprop="title">{{ c.name }}</span></a>{% endfor %}{% if program.episode_title is defined %} <span class="divider">/</span>{% endif %}</li>
    {% endif %}
    {% if program.episode_title is defined %}
    <li{% if program.season_number is not defined %} class="active"{% endif %} itemscope itemtype="http://data-vocabulary.org/Breadcrumb"><a itemprop="url" href="{{ path('any_url', {url: program.episodeof.seo_url|slice(1, program.episodeof.seo_url|length-1) }) }}"><span itemprop="title">{{ program.episodeof.title }}</span></a> {% if program.season_number is defined %} <span class="divider">/</span>{% endif %}</li>
    {% endif %}
    {% if program.season_number is defined %}
    <li class="active" itemscope itemtype="http://data-vocabulary.org/Breadcrumb"><a itemprop="url" href="{{ path('any_url', {url: program.episodeof.seo_url|slice(1, program.episodeof.seo_url|length-1) ~ 'saison-' ~ program.season_number }) }}"><span itemprop="title">Saison {{ program.season_number }}</span></a></li>
    {% endif %}
  </ul>
  {% endif %}

  <div class="view-program-column view-column pull-left actions" data-id="{{ program.id }}">
    <div style="position:relative;">
      {#<a href="#infos" class="img-resize"><i class="icon-fullscreen icon-white"></i></a>#}
      {#% if program.teaser %}
      <a class="teaser" href="#teaser"><img src="{{ asset('bundles/skreenhousefactoryv3/images/big-play.png') }}" alt="bande annonce" /></a>
      {% endif %#}
      {% if program.popular_channel is defined %}
      <a class="popular-channel" href="{{ program.popular_channel.seo_url }}"><img src="{{ program.popular_channel.img }}" alt="{{ program.popular_channel.name }}" /></a>
      {% endif %}
      <img src="{{ program.img }}" alt="{{ program.title }}" />
    </div>

    <div id="program-episodes">
      {% if program.season_number is defined %}
      <div class="btn-group program-episode season-episode">
        <button class="btn">Saison {{ program.season_number }}</button>
        <button class="btn dropdown-toggle" data-toggle="dropdown">
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          {% for season in program.seasons %}
          <li><a href="{{ path('any_url', {url: program.episodeof.seo_url|slice(1, program.episodeof.seo_url|length-1) }) }}saison-{{ season.number }}/">Saison {{ season.number }}</a></li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      {% if program.episode_number is defined %}
      <div class="btn-group program-episode">
        <button class="btn">Episode {{ program.episode_number }}</button>
        <button class="btn dropdown-toggle" data-toggle="dropdown">
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          {% for season in program.seasons if season.number == program.season_number %}
            {% for episode in season.episodes %}
            <li><a href="{{ path('any_url', {url: episode.seo_url|slice(1, episode.seo_url|length-1) }) }}">
              {% if episode.dispo %}<span class="label pull-right">{{ episode.dispo }}</span>{% endif%}
              Episode {{ episode.episode_number }} <i class="icon-chevron-right"></i> <strong>{{ episode.title }}</strong>
            </a></li>
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
      <a style="margin-top:15px;" href="{{ path('any_url', {url: program.episodeof.seo_url|slice(1, program.episodeof.seo_url|length-1) }) }}" class="btn btn-block">{{ 'program.episodes.all'|trans }}</a>
      
      {% elseif program.episodeof is defined %}
      <a href="{{ path('any_url', {url: program.episodeof.seo_url|slice(1, program.episodeof.seo_url|length-1) }) }}" class="btn btn-block">{{ 'program.episodes.all'|trans }}</a>

      {% elseif program.episode_list is defined  %}
      <div class="btn-group program-episode">
        <a class="btn btn-block dropdown-toggle" data-toggle="dropdown" href="#">
          {{ program.episode_list|length }} épisodes disponibles
          <span class="caret"></span>
        </a>
        <ul class="dropdown-menu">
          {% for episode in program.episode_list %}
          <li><a href="{{ path('any_url', {url: episode.seo_url|slice(1, episode.seo_url|length-1) }) }}">
            {% if episode.dispo %}<span class="label pull-right">{{ episode.dispo }}</span>{% endif%}
            <strong>{{ episode.title }}</strong>{% if episode.year %} - {{ episode.year }}{% endif %}
          </a></li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>
    {% if program.season_number is defined or 
          program.episode_number is defined or 
          program.episodeof is defined or 
          program.episode_list is defined  %}
    <hr/>
    {% endif %}

    <div id="program-share">
      <div class="fb-like" data-send="true" data-layout="button_count" data-width="180" data-show-faces="false"></div>
      <iframe class="pull-left" style="height: 20px;width: 100px;" allowtransparency="true" frameborder="0" scrolling="no" src="http://platform.twitter.com/widgets/tweet_button.1355514129.html#_=1356719798951&amp;id=twitter-widget-0&amp;lang=fr&amp;original_referer=http%3A%2F%2Fwww.myskreen.com{{ program.seo_url|url_encode }}&amp;size=m&amp;text=Je%20regarde%20{{ program.title|url_encode }}%20sur%20%40myskreen%20et%20vous%20%3F&amp;url=http%3A%2F%2Fwww.myskreen.com{{ program.seo_url|url_encode }}" class="block-twitter" data-twttr-rendered="true"></iframe>
      <iframe frameborder="0" scrolling="no" style="position: static; width: 90px; margin: 0px; border-style: none; height: 20px;" id="I0_{{ program.id }}" name="I0_{{ program.id }}" src="https://plusone.google.com/_/+1/fastbutton?bsv&amp;size=medium&amp;hl=fr&amp;url=http%3A%2F%2Fwww.myskreen.com{{ program.seo_url|url_encode }}&amp;id=I0_{{ program.id }}" allowtransparency="true" data-gapiattached="true" title="+1"></iframe>
    </div>

{#
    <hr/>
    <div id="program-friends">
      <p><strong>{{ 'program.friends.block.title.all'|lower|trans }}</strong></p>
      <div class="share-off">{% include 'SkreenHouseFactoryV3Bundle:Main:_fb-connect.html.twig' with {popover: 'program.friends.popover.content'|trans } %}</div>
      <div class="share-on"></div>
    </div>
#}

    <ul class="nav nav-list bs-docs-sidenav">
      <li><a href="#related"><i class="icon-chevron-right"></i> {{ 'program.related'|trans }}</a></li>
      {#% if program.teaser %}
      <li><a href="#teaser"><i class="icon-chevron-right"></i> {{ 'program.teaser'|trans }}</a></li>
      {% endif %#}
      <li><a href="#infos"><i class="icon-chevron-right"></i> {{ 'program.infos'|trans }}</a></li>
    </ul>
  </div>

  <br class="clear"/>
  <a name="related"></a>
  <div id="program-related" class="inverse">
  {% for r in program.related if r.programs is defined and r.programs|length > 0 %}
    {% if r.name == 'same_actors' and program.casting %}
      <h3 id="same-actors-title" class="user-on-visibility">{{ r.title }}</h3>
      <div class="person-list">
      {#% for pers in program.casting|slice(0,10) %}
      <a href="{{ path('any_url', {url: pers.seo_url|slice(1, pers.seo_url|length-1) }) }}" class="label label-info">{{ pers.name }}</a>
      {% endfor %#}
      </div>
      {% include 'SkreenHouseFactoryV3Bundle:Main:_slider.html.twig' with {slider: r, noheader: true} %}
    {% elseif r.name == 'same_director' and program.director %}
      <h3 id="same-director-title" class="user-on-visibility">{{ r.title }}</h3>
      <div class="person-list">
      {#% for pers in program.director %}
      <a href="{{ path('any_url', {url: pers.seo_url|slice(1, pers.seo_url|length-1) }) }}" class="label label-info">{{ pers.name }}</a>
      {% endfor %#}
      </div>
      {% include 'SkreenHouseFactoryV3Bundle:Main:_slider.html.twig' with {slider: r, noheader: true} %}
    {% else %}
      <a name="{{ r.name }}"></a>
      {% include 'SkreenHouseFactoryV3Bundle:Main:_slider.html.twig' with {slider: r} %}
    {% endif %}
  {% endfor %}
  </div>

  <br class="clear"/>
  <a name="infos"></a>
  <div id="program-infos">
    <div class="img pull-left">
      <img src="{{ program.picture }}" alt="{{ program.title }}" class="img-rounded" />
    </div>
    <p class="lead"><strong>Fiche complète</strong></h3>
    <p class="lead">
      {{ program.title }}
      <br/>
      {{ program.year }} - {{ program.duration }}mn
    </p>
    <p class="lead">
      {% if program.categories|length %}
        Catégories : {% for c in program.categories %}{% if loop.first %}{% else %}, {% endif %}<a href="{{ path('category', {format: program.format.seo_url|replace({'/': ''}), category_slug: c.seo_url|replace({'/': ''})}) }}">{{ c.name }}</a>{% endfor %}
        <br/>
      {% endif %}
      {% if program.subcategories|length %}
        Sous-catégories : {% for c in program.subcategories %}{% if loop.first %}{% else %}, {% endif %}<a href="{{ path('any_url', {url: program.format.seo_url|replace({'/': ''}) ~ c.seo_url}) }}">{{ c.name }}</a>{% endfor %}
      </ul>
      {% endif %}
      </p>

      <div class="lead">
      <small>
      {% if program.director %}
      <strong>{{ 'directed.by'|trans }} :</strong> 
      {% for pers in program.director %}
      <div class="inline" itemprop="director" itemscope="" itemtype="http://schema.org/Person">
      {% if loop.first %}{% else %}, {% endif %}<a href="{{ path('any_url', {url: pers.seo_url|slice(1, pers.seo_url|length-1) }) }}" itemprop="url"><span itemprop="name">{{ pers.name }}</span></a>
      </div>
      {% endfor %}
      {% endif %}
      <br/>
      {% if program.casting %}
      <strong>{{ 'actors'|trans }} :</strong>
      {% for pers in program.casting %}
      <div class="inline" itemprop="actor" itemscope="" itemtype="http://schema.org/Person">
      {% if loop.first %}{% else %}, {% endif %}<a href="{{ path('any_url', {url: pers.seo_url|slice(1, pers.seo_url|length-1) }) }}" itemprop="url"><span itemprop="name">{{ pers.name }}</span></a>
      </div>
      {% endfor %}
      {% endif %}
      <br/>
      {% if program.editor %}
      <strong>{{ 'editors'|trans }} :</strong>
      {% for pers in program.editor %}
      {% if loop.first %}{% else %}, {% endif %}<a href="{{ path('any_url', {url: pers.seo_url|slice(1, pers.seo_url|length-1) }) }}">{{ pers.name }}</a>
      {% endfor %}
      {% endif %}
      <br/>
      </small>
    </div>
  </div>

</div>
{% endblock %}