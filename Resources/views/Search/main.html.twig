{% extends 'SkreenHouseFactoryV3Bundle::layout.html.twig' %}

{% block title %}{{ 'page.title.search'|trans({'%q%': app.request.get('q')}) }}{% endblock %}
{% block description %}{{ 'page.description.search'|trans({'%q%': app.request.get('q')}) }}{% endblock %}
{% block meta %}<meta name="robots" content="noindex,follow" />{% endblock %}

{% block pagescripts %}
{% javascripts
    '@SkreenHouseFactoryV3Bundle/Resources/public/js/scripts/search.js'
    
    filter='?yui_js' 
    output='js/compiled/pages/search.js'  %}
    <script src="{{ asset_url }}"></script>
{% endjavascripts %}
{% endblock %}

{% block content %}
<div id="view-search" class="container">

  <div id="search-programs">
  {% if results.count is not defined or 
        results.count.total is not defined %}
    {% if results.count is defined %}
      <h1>{{ app.request.get('q') }}<small class="inline"> | {{ results.count }} {{ 'search.results'|trans }}</small></h1>
   
      {% if results.spelling|to_array|length %}
      <p class="alert alert-warning">Vouliez-vous dire : {% for spelling in results.spelling|to_array %}<a href="{{ path('search', {q: spelling}) }}">{{ spelling }}</a> ?{% endfor %}</p>
      {% endif %}


    {% else %}
      <h1>{{ app.request.get('q') }}</h1>
      <p class="alert alert-warning">{{ 'search.noresults'|trans }}</p>
        {% if results.spelling is defined%}
          {% if results.spelling and results.spelling|to_array|length %}
              <p class="alert alert-warning">Vouliez-vous dire : 
              {% for spelling in results.spelling|to_array %}<a href="{{ path('search', {q: spelling }) }}">{{ spelling }}</a> ?{% endfor %}
              </p>
          {% endif %}
      {% endif %}
    {% endif %}
    {% if results.programs is defined %}
      {% set slider = {title: '', programs: results.programs, url: results.paginate ~ '.json?format=' ~ app.request.get('format')} %}
      {% include 'SkreenHouseFactoryV3Bundle:Main:_slider.html.twig' with {slider: slider} %}
    {% endif %}

  {% else %}


    {# categories #}
    {% if results.categories is defined and results.categories|length %}
    {% for categorie in results.categories|to_array %}
    <div class="panel panel-default pull-right">
      <div class="panel-heading">Catégorie : {{ categorie.name }}</div>
        <div class="panel-body">
          <a class="btn btn-default" href="{{ path('any_url', {url: categorie.seo_url|slice(1, categorie.seo_url|length-1) }) }}">Voir la catégorie</a>
        </div>
    </div>
    {% endfor%}
    {% endif %}
  
  
    {# cinéma #}
    {% if results.theaters is defined and results.theaters|length %}
    {% for theater in results.theaters|to_array %}
    <div class="panel panel-default pull-right">
      <div class="panel-heading"><i class="glyphicon glyphicon-asterisk"></i> {{ theater.name }}, {{ theater.ville }} {{ theater.zipcode }}</div>
        <div class="panel-body">
          <a class="btn btn-default" href="{{ path('any_url', {url: theater.seo_url|slice(1, theater.seo_url|length-1) }) }}">Voir le cinéma et sa programmation</a>
        </div>
    </div>
    {% endfor%}
    {% endif %}

    {# channel #}
    {% if results.channels is defined and results.channels|length %}
    {% for channel in results.channels|to_array %}
    <div class="panel panel-default pull-right">
      <div class="panel-heading">
        <a class="btn btn-default" href="{{ path('any_url', {url: channel.seo_url|slice(1, channel.seo_url|length-1) }) }}">Voir la chaîne</a>
        <h3 class="pull-left"><i class="glyphicon glyphicon-asterisk"></i> {{ channel.name }}</h3>
      </div>
      <div class="panel-body">
        <img src="{{ channel.icon|replace({'75/100': '100/50'}) }}">
      </div>
    </div>
    {% endfor%}
    {% endif %}

    {# person #}
    {% if results.persons is defined and results.persons|length %}
    {% for person in results.persons|to_array if person.is_valid %}
    <div class="panel panel-default pull-right">
      <div class="panel-heading"><h3><i class="glyphicon glyphicon-asterisk"></i> {{ person.name }}</h3></div>
        <div class="panel-body">
          {% include 'SkreenHouseFactoryV3Bundle:Main:_btn-suivre.html.twig' with {id: person.id, name: person.name, fav: 'person'} %}
          {% if person.nb_programs %}
          &nbsp;&nbsp;
          <a class="btn btn-default" href="{{ path('any_url', {url: person.seo_url|slice(1, person.seo_url|length-1) }) }}">Voir ses {{ person.nb_programs }} programmes</a>
          {% endif %}
        </div>
    </div>
    {% endfor%}
    {% endif %}
  
    {% if results.count.total %}
      <h1>{{ app.request.get('q') }}<small class="inline"> | {{ results.count.total }} {{ 'search.results'|trans }}</small></h1>
      {% if results.spelling|to_array|length %}
      <p class="alert alert-warning">Vouliez-vous dire : {% for spelling in results.spelling|to_array %}<a href="{{ path('search', {q: spelling|url_encode}) }}">{{ spelling }}</a> ?{% endfor %}</p>
      {% endif %}
    {% else %}
      <h1>{{ app.request.get('q') }}</h1>
      <p class="alert alert-warning">{{ 'search.noresults'|trans }}</p>
      {% if results.spelling|to_array|length %}
      <p class="alert alert-warning">Vouliez-vous dire : {% for spelling in results.spelling|to_array %}<a href="{{ path('search', {q: spelling|url_encode}) }}">{{ spelling }}</a> ?{% endfor %}</p>
      {% endif %}
    {% endif %}


  {% set hasActiveTabYet = false %}
  {% set keys = {
    'films': 'Films',
    'documentaires': 'Documentaires',
    'emissions': 'Emissions',
    'series': 'Séries',
    'spectacles': 'Spectacles',
    'archives': 'Archives',
    'nouveautes': 'Nouveautés'
  } %}
    <ul id="triggers" class="nav nav-pills clear" style="font-size: 1.2em;">
    {% for key,val in keys %}
      {% if attribute(results.count,key) %}
      {% set nb = attribute(results.count,key) %}
    <li{% if hasActiveTabYet == false %} class="active"{% set hasActiveTabYet = key %}{% endif %}><a href="#{{ key }}" id="trigger-{{ key }}" data-toggle="tab" data-nb="{{ nb }}">{{ val }}<span>{{ nb }}</span></a></li>
    {% endif %}
    {% endfor %}
        <li class="pull-right"><a href="#youtube" id="trigger-youtube" data-toggle="tab">YouTube</a></li>
    </ul>

    <br/>
    <div class="tab-content">
    {% for key,val in keys %}
    <div id="{{ key }}" class="tab-pane{% if hasActiveTabYet == key %} active{% endif %}">
      {% if attribute(results.count,key) %}
        <div id="user-programs" class="slider slider-list">
          <ul class="items">
        {% for p in attribute(results,val)|to_array %}
          {% include 'SkreenHouseFactoryV3Bundle:Main:_program.html.twig' with {'p': p} %}
        {% endfor %}
          </ul>
      </div>
      {% endif %}
    </div>
    {% endfor %}
    <div id="youtube" class="tab-pane" data-more-streaming-query="{{ results.query }}">
      <div id="carousel-youtube" class="carousel slide">
          <div class="carousel-inner"></div>
            <a class="carousel-control left" href="#carousel-youtube" data-slide="prev">&lsaquo;</a>
            <a class="carousel-control right" href="#carousel-youtube" data-slide="next">&rsaquo;</a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  </div>
  <div id="bottom-search-results"></div>
</div>
{% endblock %}