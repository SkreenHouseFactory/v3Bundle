{% extends 'SkreenHouseFactoryV3Bundle::layout.html.twig' %}

{% block title %}{{ 'page.title.search'|trans({'%q%': app.request.get('q')}) }}{% endblock %}
{% block description %}{{ 'page.description.search'|trans({'%q%': app.request.get('q')}) }}{% endblock %}
{% block meta %}<meta name="robots" content="noindex,follow" />{% endblock %}

{% block pagescripts %}
{% javascripts
    '@SkreenHouseFactoryV3Bundle/Resources/public/js/scripts/search.js'
    
    filter='?yui_js' 
    output='js/compiled/pages/search.js'  %}
    <script src="{{ asset_url }}"></script>
{% endjavascripts %}
{% endblock %}

{% block content %}
<div id="view-search" class="container">

  <div id="search-programs">
  {% if results.count is not defined or 
        results.count.total is not defined %}
    {% if results.count is defined %}
      <h1>{{ app.request.get('q') }}<small class="inline"> | {{ results.count }} {{ 'search.results'|trans }}</small></h1>
      {% if results.spelling|to_array|length %}
      <p class="alert alert-warning">Vouliez-vous dire : {% for spelling in results.spelling|to_array %}<a href="{{ path('search', {q: spelling}) }}">{{ spelling }}</a> ?{% endfor %}</p>
      {% endif %}
    {% else %}
      <h1>{{ app.request.get('q') }}</h1>
      <p class="alert alert-warning">{{ 'search.noresults'|trans }}</p>
      {% if results.spelling and results.spelling|to_array|length %}
      <p class="alert alert-warning">Vouliez-vous dire : 
      {% for spelling in results.spelling|to_array %}<a href="{{ path('search', {q: spelling }) }}">{{ spelling }}</a> ?{% endfor %}
        </p>
      {% endif %}
    {% endif %}
    {% set slider = {title: '', programs: results.programs, url: results.paginate ~ '.json?format=' ~ app.request.get('format')} %}
    {% include 'SkreenHouseFactoryV3Bundle:Main:_slider.html.twig' with {slider: slider} %}

  {% else %}
  
    {% if results.person is defined  and results.person %}
    <p class="pull-right">
      {% include 'SkreenHouseFactoryV3Bundle:Main:_btn-suivre.html.twig' with {id: results.person.id, name: results.person.name, fav: 'person'} %}
      &nbsp;&nbsp;
      <a class="btn btn-default" href="{{ path('any_url', {url: results.person.seo_url|slice(1, results.person.seo_url|length-1) }) }}">Voir tous ses programmes</a>
    </p>
    {% endif %}
  
    {% if results.count.total %}
      <h1>{{ app.request.get('q') }}<small class="inline"> | {{ results.count.total }} {{ 'search.results'|trans }}</small></h1>
      {% if results.spelling|to_array|length %}
      <p class="alert alert-warning">Vouliez-vous dire : {% for spelling in results.spelling|to_array %}<a href="{{ path('search', {q: spelling|url_encode}) }}">{{ spelling }}</a> ?{% endfor %}</p>
      {% endif %}
    {% else %}
      <h1>{{ app.request.get('q') }}</h1>
      <p class="alert alert-warning">{{ 'search.noresults'|trans }}</p>
      {% if results.spelling|to_array|length %}
      <p class="alert alert-warning">Vouliez-vous dire : {% for spelling in results.spelling|to_array %}<a href="{{ path('search', {q: spelling|url_encode}) }}">{{ spelling }}</a> ?{% endfor %}</p>
      {% endif %}
    {% endif %}


  {% set hasActiveTabYet = false %}
  {% set keys = {
    'films': 'Films',
    'documentaires': 'Documentaires',
    'emissions': 'Emissions',
    'series': 'Séries',
    'spectacles': 'Spectacles',
    'archives': 'Archives',
    'nouveautes': 'Nouveautés'
  } %}
    <ul id="triggers" class="nav nav-pills clear" style="font-size: 1.2em;">
    {% for key,val in keys %}
      {% if attribute(results.count,key) %}
      {% set nb = attribute(results.count,key) %}
    <li{% if hasActiveTabYet == false %} class="active"{% set hasActiveTabYet = key %}{% endif %}><a href="#{{ key }}" id="trigger-{{ key }}" data-toggle="tab" data-nb="{{ nb }}">{{ val }}<span>|{{ nb }}</span></a></li>
    {% endif %}
    {% endfor %}
        <li class="pull-right"><a href="#youtube" id="trigger-youtube" data-toggle="tab">YouTube</a></li>
    </ul>

    <br/>
    <br/>
    <div class="tab-content">
    {% for key,val in keys %}
    <div id="{{ key }}" class="tab-pane{% if hasActiveTabYet == key %} active{% endif %}">
      {% if attribute(results.count,key) %}
        <div id="user-programs" class="slider slider-list">
          <ul class="items">
        {% for p in attribute(results,val)|to_array %}
          {% include 'SkreenHouseFactoryV3Bundle:Main:_program.html.twig' with {'p': p} %}
        {% endfor %}
          </ul>
      </div>
      {% endif %}
    </div>
    {% endfor %}
    <div id="youtube" class="tab-pane" data-more-streaming-query="{{ results.query }}">
      <div id="carousel-youtube" class="carousel slide">
          <div class="carousel-inner"></div>
            <a class="carousel-control left" href="#carousel-youtube" data-slide="prev">&lsaquo;</a>
            <a class="carousel-control right" href="#carousel-youtube" data-slide="next">&rsaquo;</a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  </div>
  <div id="bottom-search-results"></div>
</div>
{% endblock %}